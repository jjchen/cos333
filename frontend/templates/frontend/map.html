<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>{% load staticfiles %}

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />

    <link rel="stylesheet" type="text/css" href="{% static "frontend/style.css" %}" />
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbkTcw7IQzJtELnuovVYEMDQg-zex6oG0&sensor=true">
    </script>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
    <script type="text/javascript" src="{% static "frontend/oms.min.js" %}">
    </script>

    <!-- trying out some ajax, YOLO --> 
    <script type="text/javascript" 
    src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script type="text/javascript">

  jQuery(function() {
      var form = jQuery("#eventform");
      var tags = jQuery("#singleFieldTags");
      form.submit(function(e) {
          jQuery("#sendbutton").attr('disabled', true)
          jQuery("#sendwrapper").prepend('<span>Submitting event, please wait... </span>')
          jQuery("#ajaxwrapper").load(
              form.attr('action') + ' #ajaxwrapper',
              form.serializeArray(),
              function(responseText, responseStatus) {
                  jQuery("#sendbutton").attr('disabled', false)
              }
          );
          e.preventDefault(); 
      });
  });

  </script>

  <!-- NEW AUTOCOMPLETE!!!11!!! -->

  <!-- INSTRUCTIONS -->

    <!-- 2 CSS files are required: -->
    <!--   - Tag-it's base CSS (jquery.tagit.css). -->
    <!--   - Any theme CSS (either a jQuery UI theme such as "flick", or one that's bundled with Tag-it, e.g. tagit.ui-zendesk.css as in this example.) -->
    <!-- The base CSS and tagit.ui-zendesk.css theme are scoped to the Tag-it widget, so they shouldn't affect anything else in your site, unlike with jQuery UI themes. -->
    <link href="{% static "frontend/jquery.tagit.css" %}" rel="stylesheet" type="text/css">
    <link href="{% static "frontend/tagit.ui-zendesk.css" %}" rel="stylesheet" type="text/css">
    <!-- If you want the jQuery UI "flick" theme, you can use this instead, but it's not scoped to just Tag-it like tagit.ui-zendesk is: -->
    <!--   <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/flick/jquery-ui.css"> -->

    <!-- jQuery and jQuery UI are required dependencies. -->
    <!-- Although we use jQuery 1.4 here, it's tested with the latest too (1.8.3 as of writing this.) -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.12/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>

    <!-- The real deal -->
    <script src="https://raw.github.com/aehlke/tag-it/master/js/tag-it.js" type="text/javascript" charset="utf-8"></script>

    <script>
        $(function(){
            var sampleTags = ['cos', '333', 'music', 'needs', 'database', 'integration'];

            //-------------------------------
            // Minimal
            //-------------------------------
            $('#myTags').tagit();

            //-------------------------------
            // Single field
            //-------------------------------
            $('#singleFieldTags').tagit({
                availableTags: sampleTags,
                // This will make Tag-it submit a single form value, as a comma-delimited field.
                singleField: true,
                singleFieldNode: $('#id_tags')
            });

            // singleFieldTags2 is an INPUT element, rather than a UL as in the other 
            // examples, so it automatically defaults to singleField.
            $('#singleFieldTags2').tagit({
                availableTags: sampleTags
            });

            //-------------------------------
            // Preloading data in markup
            //-------------------------------
            $('#myULTags').tagit({
                availableTags: sampleTags, // this param is of course optional. it's for autocomplete.
                // configure the name of the input field (will be submitted with form), default: item[tags]
                itemName: 'item',
                fieldName: 'tags'
            });

            //-------------------------------
            // Tag events
            //-------------------------------
            var eventTags = $('#eventTags');

            var addEvent = function(text) {
                $('#events_container').append(text + '<br>');
            };

            eventTags.tagit({
                availableTags: sampleTags,
                beforeTagAdded: function(evt, ui) {
                    if (!ui.duringInitialization) {
                        addEvent('beforeTagAdded: ' + eventTags.tagit('tagLabel', ui.tag));
                    }
                },
                afterTagAdded: function(evt, ui) {
                    if (!ui.duringInitialization) {
                        addEvent('afterTagAdded: ' + eventTags.tagit('tagLabel', ui.tag));
                    }
                },
                beforeTagRemoved: function(evt, ui) {
                    addEvent('beforeTagRemoved: ' + eventTags.tagit('tagLabel', ui.tag));
                },
                afterTagRemoved: function(evt, ui) {
                    addEvent('afterTagRemoved: ' + eventTags.tagit('tagLabel', ui.tag));
                },
                onTagClicked: function(evt, ui) {
                    addEvent('onTagClicked: ' + eventTags.tagit('tagLabel', ui.tag));
                },
                onTagExists: function(evt, ui) {
                    addEvent('onTagExists: ' + eventTags.tagit('tagLabel', ui.existingTag));
                }
            });

            //-------------------------------
            // Read-only
            //-------------------------------
            $('#readOnlyTags').tagit({
                readOnly: true
            });

            //-------------------------------
            // Tag-it methods
            //-------------------------------
            $('#methodTags').tagit({
                availableTags: sampleTags
            });

            //-------------------------------
            // Allow spaces without quotes.
            //-------------------------------
            $('#allowSpacesTags').tagit({
                availableTags: sampleTags,
                allowSpaces: true
            });

            //-------------------------------
            // Remove confirmation
            //-------------------------------
            $('#removeConfirmationTags').tagit({
                availableTags: sampleTags,
                removeConfirmation: true
            });
            
        });
    </script>

    <script type="text/javascript">
      var map;
      var idled = false;
      var oms;
      var image = '{% static "frontend/paw_print.png" %}';
      var flower = '{% static "frontend/small_flower.png" %}';
      var geocoder;

      function initialize() {
      var center = new google.maps.LatLng(40.344725, -74.655629);
      geocoder = new google.maps.Geocoder();
      var mapOptions = {
      center: center,
      zoom: 17,
      mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById("map-canvas"),
      mapOptions);
      oms = new OverlappingMarkerSpiderfier(map, {
      keepSpiderfied: true
      });

      var iw = new google.maps.InfoWindow();
      oms.addListener('click', function (marker) {
      iw.setContent(marker.desc);
      iw.open(map, marker);
      });

      oms.addListener('spiderfy', function (markers) {
      iw.close();
      for (i = 0; i < markers.length; i++) {
              markers[i].setIcon(image);
              }
              });

              oms.addListener('unspiderfy', function (markers) {
              iw.close();
              for (i = 0; i < markers.length; i++) {
                      markers[i].setIcon(flower);
                      }
                      });

                      google.maps.event.addListener(map, 'idle', function () {
                      if (!idled) {
                      var overlapped = oms.markersNearAnyOtherMarker();
                      for (i = 0; i < overlapped.length; i++) {
                              overlapped[i].setIcon(flower);
                              }
                              }
                              idled = true;
                              });

                              google.maps.event.addListener(map, 'click', function() {
                              iw.close();
                              });

                              {% if events_list %}
                              showEventsOnMap(); 
                              {% endif %}

                              {% if show_list == True %}
                              showContent('list_content');
                              {% endif %}
                              }
                              google.maps.event.addDomListener(window, 'load', initialize);

                              function showEventsOnMap() {

                              var i = 0; 
                              {% for event in events_list %} 
                              {% if event.lat %}
                              var position = new google.maps.LatLng({{event.lat}}, {{event.lon}});

                              var marker = new google.maps.Marker({
                              map: map,
                              position: position,
                              icon: image
                              });

                              var contentString = '<div class="infoWindow_content">' +
                              '<h3 class="infoWindow_heading">{{event.name}}</h3>' +
                              '<div id="infoWindow_body">' +
                              '<p>Time: {{event.time}} {{event.date}}</p>' +
                              '<p>Location: {{event.location}}</p>' +
                              '</div>' +
                              '</div>';

                              marker.desc = contentString;

                              oms.addMarker(marker); 
                              {% else %}
                              codeAddress("{{event.location}}");
                              {% endif %} 
                              {% endfor %}
                              }

                              function codeAddress(buildingName) {
                              geocoder.geocode( { 'address': buildingName }, function(results, status) {
                              if (status == google.maps.GeocoderStatus.OK) {
                              // map.setCenter(results[0].geometry.location);
                              var marker = new google.maps.Marker({
                              map: map,
                              position: results[0].geometry.location
                              });
                              var contentString = '<div class="infoWindow_content">' +
                              '<h3 class="infoWindow_heading">{{event.name}}</h3>' +
                              '<div id="infoWindow_body">' +
                              '<p>Time: {{event.time}} {{event.date}}</p>' +
                              '<p>Location: {{event.location}}</p>' +
                              '</div>' +
                              '</div>';

                              marker.desc = contentString;

                              oms.addMarker(marker);
                              } else {
                              //  alert("Geocode was not successful for the following reason: " + status);
                              }
                              }); 
                              }

                              function showContent(id) {
                              //alert(id);
                              var elem = document.getElementById('content_wrapper');
                              for (i = 0; i < elem.children.length; i++) {
                                      if (elem.children[i].id != id) {
                                      elem.children[i].className = 'hidden';
                                      } else {
                                      elem.children[i].className = (elem.children[i].className == 'hidden') ? 'visible' : 'hidden';
                                      if (id == "list_content" && elem.children[i].className == 'visible') makeList();
                                      }
                                      }
                                      }

                                      function makeList(){
                                      var parent = document.getElementById("list_inner_wrapper");
                                      var html = "";
                                      {% if events_list %}
                                      html += "<table class='list_table'>"
                                      var cur_date = "";
                                      var i = 0;
                                      {% for event in events_list %}
                                      if (i % 2 == 0) {
                                      row_class = "rowColor";
                                      } else {
                                      row_class = "";
                                      }
                                      i++;

                                      if ('{{event.date}}' != cur_date) {
                                      html += '<tr><td colspan="2"> <h3> {{event.date}} </h3></td></tr>';
                                      cur_date = '{{event.date}}';
                                      }
                                      html += '<tr class="'+ row_class
                                              + '"><td class="list_time" rowspan="2"> {{event.time}} </td>' 
                                      + '<td> {{event.name}} at <FONT COLOR="006633"><b> {{event.location}}</b></FONT> </td>'  
                                      + '<tr class="'+row_class+'"><td> <small>{{event.tags}}</small></td></tr>'
                                      {% endfor %}
                                      html += "</table>"
                                      {% else %}
                                      html += '<p>No events :(</p>';
                                      {% endif %}
                                      parent.innerHTML = html;
                                      }
                                      </script>
  </head>
  
  <body>
    <header>
      <h1>Princeton University - OC</h1>
    </header>

    <div id="side_panel">
      <h3>Filter</h3>

      <br/>
      <form action="{% url 'frontend:index' %}" method="post">{% csrf_token %}
        <input type="text" id="search_query" placeholder="Search" name="search_query" required>
        <input type="submit" value="Go">
      </form>
      <br/>
      <a href="{% url 'frontend:index' %}"> All </a>
      <br/>
      <br/>{{user}}
      <div id="time_slider">
        <h3>Time</h3>

        <input type="range">
      </div>
    </div>
    <div id="content_wrapper">
      <div id="list_content" class="hidden">

        <div id="list_inner_wrapper">
        </div>
      </div>

      <div id="make_content" class="hidden">
        <h3>Make Event</h3>

        <!-- ABANDON HOPE -->

     
            
        <!-- NO REALLY, YOU MADE IT -->


        <form action="/add/" method="post" id="eventform">{% csrf_token %}
          {{ form.non_field_errors }}
          <div id="ajaxwrapper">
          <div class="fieldWrapper">
              {{ form.name.errors }}
              <label for = "id_name">Name:</label>
              <input type="text" name="name" id="id_name" {% if form.name.errors %} class="valerror"{% endif %}/>
          </div>
          <div class="fieldWrapper">
              {{ form.date.errors }}
              <label for = "id_date">Date:</label>
              <input type="text" name="date" id="id_date" {% if form.date.errors %} class="valerror"{% endif %}/>
          </div>
          <div class="fieldWrapper">
              {{ form.time.errors }}
              <label for = "id_time">Time:</label>
              <input type="text" name="time" id="id_time" {% if form.time.errors %} class="valerror"{% endif %}/>
          </div>
          <div class="fieldWrapper">
              {{ form.location.errors }}
              <label for = "id_form">Location:</label>
              <input type="text" name="location" id="id_form" {% if form.location.errors %} class="valerror"{% endif %}/>
          </div>
            <!--<div class="ui-widget">-->
            {{ form.tags.errors }}
             <label for="tags">Tags:</label>
             <input type="text" id="id_tags" name="tags"/> 
            <ul id="singleFieldTags"></ul>
          <!--</div>-->
          <p id="sendwrapper"><input type="submit" value="Submit event" id="sendbutton" /></p>
        </div>

        </form>
    
    <body>
        <header>
            <div id="logo"><a href="{%url 'frontend:index' %}"><h1>OC - Princeton University</h1></a></div>
            <div id="floatright">
                <div class="settings_buttons" onclick="window.location.href={% url 'frontend:personal' %}"> {{user}} </div>
                <div class="settings_buttons" onclick="window.location.href={% url 'frontend:settings' %}"> settings </div>
                <div class="settings_buttons" onclick="window.location.href={% url 'frontend:logout' %}"> logout </div>
            </div>
        </header>
        <div id="side_panel">
              <h3>Filter</h3>

            <br/>
            <form action="{% url 'frontend:index' %}" method="post">{% csrf_token %}
                {{ form.as_p}}
                <input type="submit" value="Go">
            </form>
            <br/>
            <a href="{% url 'frontend:index' %}"> All </a>
            <div id="time_slider">
                 <h3> Time </h3>

                <input type="range">
            </div>
        </div>
        <div id="content_wrapper">
            <div id="list_content" class="hidden">

                <div id="list_inner_wrapper">
                </div>
            </div>
            <div id="make_content" class="hidden">
                  <h3> Make Event </h3>

                <form action="/add/" method="post">{% csrf_token %}
                    <label for = "id_name">Name:</label> 
                    <input type="text" id="id_name" name="name" required>
                    <label for = "id_date">Date:</label>
                    <input type="date" id="id_date" name="date">
                    <label for = "id_time">Time:</label>
                    <input type="time" id="id_time" name="time">
                    <label for = "id_location">Location:</label>
                    <input type="text" id="id_location" name="location">
                  <!--<div class="ui-widget">-->
                    <label for="tags">Tags:</label>
                    <input type="text" id="tags" name="tags" size="50" />
                  <!--</div>-->
                    <input type="submit" value="Submit">
                </form>
            </div>
            <div id="calendar_content" class="hidden">
                  <h3>Calendar</h3>

                <li><a rel="nofollow" href="{% url 'socialauth_begin' 'facebook' %}">Facebook</a>
                </li>
                <li><a rel="nofollow" href="{% url 'django_cas.views.login' %}">CAS</a>
                </li>
            </div>
            <div id="settings_content" class="hidden">
                  <h3>Settings</h3>
            </div>
        </div>
        <div id="make_button" class="button" onclick="showContent('make_content');">
              <h3>Make</h3>
	      <div id="fb-root"></div>
	      <script>
		window.fbAsyncInit = function() {
		// init the FB JS SDK
		FB.init({
		appId      : '431733443585073',                        // App ID from the app dashboard
		channelUrl : '//www.cos333-oc.herokuapp.channel.html', // Channel file for x-domain comms
		status     : true,                                 // Check Facebook Login status
		xfbml      : true                                  // Look for social plugins on the page
		});

		// Additional initialization code such as adding Event Listeners goes here
		};

		// Load the SDK asynchronously
		(function(d, s, id){
		var js, fjs = d.getElementsByTagName(s)[0];
		if (d.getElementById(id)) {return;}
		js = d.createElement(s); js.id = id;
		js.src = "//connect.facebook.net/en_US/all.js";
		fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
	      </script>
        </div>
        <div id="calendar_button" class="button" onclick="showContent('calendar_content');">
          <h3>Calendar</h3>

        </div>
        <div id="list_button" class="button" onclick="showContent('list_content');">
          <h3>List</h3>
        </div>
        <div id="minus_button" class="button" onclick="showContent('none');">
          <h3>-</h3>

        </div>
        <div id="map-canvas" />
    </body>


</html>
